<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>南区踩盘分配</title>
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css"/>
    <style>
        html, body, #container {
            height: 100%;
            width: 100%;
        }

        #panel {
            width:100%;
            height: 3em;
            text-align: right;
            display:block;
            position:absolute;
            bottom: 0;
            right:0;
            float:right;
            z-index: 9999;
            padding:5px;
        }
        #panel button{
            margin-right:2px;
            border:1px solid #eee;
            color:#FFF;
            text-shadow: #000 1px 1px 1px;
            border-radius: 5px;
            padding:0.5em;
        }

    </style>
</head>
<body>

<div id="panel"></div>
<div id="container"></div>
<script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=3427e2b77a4a280034b7a59f136c33a9"></script>
<script type="text/javascript" src="amap_assign.js"></script>
<script type="text/javascript" src="amap_project.js"></script>
<script type="text/javascript">
    var colors = ["#00FFFF","#0000FF", "#FF00FF", "#008000", "#00FF00",
    "#800000", "#000080", "#808000","#FFFF00","#800080", "#FF0000"
    ]
    var count = {}
    var assignTable = {}
    var assign_print = ""
    var total = 0
    for(i in assign){
        assignedTo = assign[i]
        if(typeof count[assignedTo] == "undefined"){
            count[assignedTo]= 1
            assignTable[assignedTo] = [i]
        }else{
            count[assignedTo]++
            assignTable[assignedTo].push(i)
        }
        assign_print += i + "\t"+assignedTo+"\n";
        total++
    }
    for(i in count){
        console.log(i+":"+count[i])
    }
    console.log(assignTable)
    console.log(assign_print)
    console.log(total)

   

    var marker, map = new AMap.Map("container", {
        resizeEnable: true,
        center: [104.067971,30.548987],
        zoom: 13
    });

    function getAssigned(projectName){
        if(typeof assign[projectName] == "undefined"){
            return ""
        }else{
            return assign[projectName]
        }
    }

    var selectedColor = {}
    function getColor(projectName){
        let name = getAssigned(projectName)
        if(name == ""){
            return "#CCCCCC"
        }else{
            if(typeof selectedColor[name] == "undefined"){
                selectedColor[name] = colors.shift()
            }
            return selectedColor[name]
        }
    }
    
    


    var markerGroup = {}
    var markerGroupShow={}

    for( i in projects){
        let project = projects[i]
        lnglat = project.loc.split(",")
        if(lnglat.length != 2){
            continue;
        }

        let lnglat1 = new AMap.LngLat(lnglat[0],lnglat[1])
        //map.add(new AMap.Marker({
        //    position: new AMap.LngLat(lnglat[0],lnglat[1]), 
        //    title: project.name
        //}))

        let m = new AMap.CircleMarker({
            center: lnglat1, 
            radius:10,
            bubble:true,
            strokeOpacity:0,
            fillColor:getColor(project.name),
            fillOpacity:0.9
        })

        let assignToUser = getAssigned(project.name)
        if(typeof markerGroup[assignToUser] == "undefined"){
            markerGroup[assignToUser] = [m]
            markerGroupShow[assignToUser] = true
        }else{
            markerGroup[assignToUser].push(m)
        }

        m.on("mouseover",function(){
            //console.log(project)
            infoWindow = new AMap.InfoWindow({
                anchor: 'top-left',
                content: project.name + " ,("+getAssigned(project.name)+")",
            });
            infoWindow.open(map,lnglat1)
        })
        map.add(m)

        
    }


    console.log("markerGroup",markerGroup)

    let text = ""
    
    for( i in markerGroup){
        text +="<button style=\"background-color:"+selectedColor[i]+"\" onclick=\"toggle('"+i+"')\">"+i+"</button>"
    }
    document.getElementById("panel").innerHTML = text

    function toggle(id){
        let show = false
        if(markerGroupShow[id]){
            markerGroupShow[id]=false
        }else{
            markerGroupShow[id]=true
            show = true
        }
        let markers = markerGroup[id]
        for(i in markers){
            if(show){
                markers[i].show()
            }else{
                markers[i].hide()
            }
        }
    }
    
</script>
</body>
</html>